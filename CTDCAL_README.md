# CTDCAL

A toolbox containing functions and scripts for CTDO sensor calibration and reporting

### Usage

1. Start by inputting the correct cruise and parameter information in settings.py,
this will be used to import/export the correct station and parameters for analysis and choosing which sensors will be calibrated.

2. Modify the template_scipt.py file in any way necessary
  * There is a function in the Jupyter notebook to remove stations or to use the last instance of each station for analysis.

3. Run CTDCAL

### Description of Processes and Functions used.

This is a step-by-step guide and explanation of each step used in the template_scipt.py script.

1. Fill out `settings.py`, this will contain the station cast listing `ssscc`, directory lists, import/export parameters, and other cruise information.

2. *Convert raw CTD files to Pandas Dataframes using sbe_convert.py*

   1. `sbe_convert.convert_sbe`: Converts raw CTD files into Pandas DataFrames, outputs a .pkl file into the `converted_directory` found in the `settings.py` module, and generates a cast_details.csv file in the `log_directory`. This is done for all stations found in `ssscc`.

   2. `sbe_convert.sbe_metadata`: Reads in the converted CTD files and generates a pressure sequenced CTD file containing the continuous CTD downcast measurement and determines the starting and ending pressure for each cast. These files are saved in the `time_data_directory` directory.

   3. `sbe_convert.process_bottle`: Reads in the converted CTD files, determines bottle fire values for the upcast, and writes out a bottle file into the `bottle_directory`.

3. *File I/O*

   1. `process_ctd.load_all_ctd_files`: This function reads in parameters specified by the `ctd_input_array` in `settings.py`. There is an argument to choose whether to load in 'time' data or 'bottle' data. If 'bottle' data is chosen, the function will load in data from the in-situ measurements.

    **Note:** This function contains error catching features for human errors on the insitu measurement. If files are not found or mislabel, the function will load default values of `NaN` to the missing parameters. **Take note of the output of this function to determine missing files/parameters.**

    This returns a master DataFrame for the Bottle Data and the CTD (Time) Data.

4. *Pressure Calibration*

   1. `process_ctd.load_pressure_logs`: This function reads in a csv found in the `log_directory` generated by `sbe_convert.sbe_metadata` that contains the start and end pressures for each cast and puts them in a Pandas DataFrame.

   2. `process_ctd.get_pressure_offset`: This function calculates the average starting pressure and the average ending pressure to determine an average pressure offset.

   3. `fit_ctd.apply_pressure_offset`: This function applies a given offset (usually determined by `get_pressure_offset` to an array-like of pressure values).

5. *Temperature and Conductivity Calibration*

   1. `process_ctd.prepare_fit_data`: This function takes in a Pandas DataFrame and returns one that has any missing reference parameters values removed.

   2. `process_ctd.quality_check`: This function compares two sets of data (either primary sensor data with reference data, secondary sensor data with reference data, or primary sensor data with secondary sensor data) for temperature or conductivity. There values are automatically flagged as good (WOCE 2) or questionable (WOCE 3) based upon differences in the two sets of data and whether or not the 'good' or 'quest' argument is provided. Returns either a DataFrame containing question or good values depending on arguments provided.

   3. `process_ctd.calibrate_param`: This function will calibrate the primary or secondary sensors for temperature or salinity. First the calibration parameter is automatically QC'ed where the good (WOCE 2) values are calibrated and the questionable (WOCE 3) values are stored in a DataFrame to be exported later. The good values are then constrained by pressure as denoted by `xRange` and either a 0th, 1st, or 2nd order polynomial fit is used to determine the coefficients. Returns coefficients and a DataFrame containing questionable values for the parameter and order specified.

   4. `fit_ctd.temperature_polyfit` and `fit_ctd.conductivity_polyfit`: This function simply applies the coefficients determined from `process_ctd.calibrate_param` to the bottle and CTD data.

   5. `process_ctd.combine_quality_flags`: This function concatenates the questionable value DataFrames determined from using `quality_check` into one DataFrame to be exported later.

6. *Oxygen Calibration*

   1. Calculate Oxygen parameters: The first part of the oxygen fitting is calculating the necessary parameters for the fitting.
       * Calculate sigma0 for the BTL and CTD data.
       * Calculate the reference **OXYGEN** using the winkler titration data.
       * Calculate Absolute Salinity (SA) and Potential Temperature (PT) for BTL and CTD  using the gsw library.
       * Calculate Oxygen Solubility (OS) for BTL and CTD data.

   2. `oxy_fitting.oxy_fit`: This is the fitting function used to determine the fitting coefficients. The CTD data is density matched to the bottle data and a regression is used to determine coefficients where initial coefficients are given by the Seabird .hex and .XMLCON files for that given station. The regression is then repeated using new coefficients until all residuals between the **OXYGEN** and **CTDOXY** are within 2.8 standard deviations as noted in *CTD Oxygen Calibration Procedure (Millard)*. The regression uses 3 methods:
       * Weighted regression: A regression using weights proportional to pressure.
       * Unweighted regression: An unweighted regression in the case that the weighted regression fails.
       * Seabird coefficients: If both the weighted and unweighted regression fail, the Seabird coefficients are used.
  Anything outside of the 2.8 standard deviation range is flagged questionable (WOCE 3) and the values within the STD range is flagged (WOCE 2).
  The function returns the QC'ed DataFrame and the coefficients for that station.

   3. Cleanup: All coefficients are stored into a DataFrame for export later, the **CTDOXY** values are merged into the master bottle DataFrame and the the coefficients are then applied to the time data.

7. *Clean and Export Data*

   1. Merging flags to bottle data: The automatically QC'ed flags are merged back into the master bottle file for conductivity, reference conductivity, and reference temperature.

   2. The questionable value DataFrames determined in the *Temperature and Conductivity Calibration* section are exported to .csv files along with the oxygen coefficients.

   3. Any erroneous columns are dropped.

   4. Bottle data **Date** and **Time** are determined by converting epoch time to **YYYYMMDD** and **HHMM** respectively.

   5. `process_ctd.export_btl_data` and `process_ctd.export_time_data`: Exports CTD and BTL master DataFrames to ct and hy files using information found in `settings.py`.
